#include "ntt.h"
#include "params.h"
#include "reduce.h"
#include <stdint.h>


const int32_t zetas[1024] = {
    -48648, 5436, 11575, -35411, -7910, 35297, -22576, 14541, -4106, 38484, -36189, -10897, -13682, -3134, -53153, -35468, 
    17865, 59376, -61937, 60478, 5581, -59960, -21197, 53036, 23328, -62764, 17304, -60252, -66281, 11905, 43006, 60737, 
    12725, -52155, 12589, -44850, -40920, 36687, 64968, 49811, 14269, 37186, 11543, 28953, -5818, 20812, 64984, 17629, 
    42604, -29257, -38519, 49652, 38801, 15465, -938, 56256, 23911, 45894, 12943, 8569, 35778, 22206, -38378, 15650, 
    7166, -3165, 28598, 20250, 27380, -25914, -42690, 35834, -63876, -49736, 44653, 26107, -7168, 40468, 56587, 17418, 
    4806, -48676, 40543, 6076, -37999, -64416, 53850, 14670, -25043, 34486, 11965, 12159, -126, -46089, 41815, -23094, 
    50703, -61981, -12105, -63369, -57282, -33923, -58103, 36604, 43339, 39914, 5989, 51246, -8808, 11098, 19762, 21106, 
    -34209, -66350, -29073, -13334, -12967, 39704, 44479, -56557, 24942, 52182, -36555, 26381, -23035, -10725, -50093, -149, 
    -56980, 57527, -8301, -60182, 26834, 40609, 49761, -64240, -6670, -62630, 11761, -43444, -53350, -21950, -65595, -3408, 
    -54042, -27849, -11326, -16138, 41552, 23334, 40135, 27991, 32643, -12021, 35307, -45484, -28498, -21706, 3787, -12540, 
    25664, 31020, -37389, 6575, 64768, 52723, 35443, -52789, -57225, 34470, -23137, 28034, -1670, -2309, 42861, 36224, 
    -16189, -35855, 29763, 56536, -65422, 31347, -2237, -10028, -13226, 11526, -39667, 29093, 47291, -54901, -54627, 33917, 
    27592, 13598, -20072, 36656, -19003, -208, -56963, -59867, 4912, -28920, 51852, 6487, 4761, 58476, 26951, 54880, 
    -1595, -3401, -23233, -45116, 4606, -45764, 39299, 45488, -45674, 47332, -60449, -3786, 41424, 14548, 34014, 42565, 
    27962, 34835, 62102, -9632, -33008, -35913, 2359, -2398, 8413, -31971, -35531, -36452, 43142, 53432, -56472, 34156, 
    64452, -43848, 49452, 41431, 28540, 37069, -62099, 20238, 15488, -1862, -58085, -32881, -46562, -30261, -44673, -52440, 
    21668, 14654, 33603, 53874, -50220, 38974, 7122, 18775, 11461, -39076, -64496, 65788, -43446, 25542, -41266, -32823, 
    15981, 54858, 43491, 427, -31043, -11275, -25355, -3570, -61419, -16287, -38574, -56044, -40804, 3049, 49715, -4997, 
    52180, 12361, -21555, -58898, 61308, 23228, 40546, 16682, 4426, -16519, -15069, -25538, -63192, -27746, 64882, 56388, 
    -29243, -37483, -14159, 41085, 43718, -40152, 37633, -31427, 26598, 49370, -15605, -12409, -28151, -37408, -65940, -25009, 
    -16436, -21609, -33009, 49299, -21893, -11378, 31558, 57025, 22934, -35728, 25503, 38689, 13394, 49926, -60460, 1699, 
    -11729, -20920, 30880, 56247, -21965, 320, 36435, -51258, -17797, 3532, -38812, -9980, -58525, 53398, -31223, 17970, 
    42204, -23433, -41007, -4645, -64788, 54065, 17681, 30106, 23724, 6018, 57041, -63740, 48253, -26309, -27344, 20065, 
    18422, -12632, -23861, -46622, -20899, -47150, 27091, -27031, -2703, 28706, 44423, 56080, -25412, 61158, -46241, 39613, 
    -4809, 38070, 20674, 50426, -53633, -1855, -59368, 1774, -27874, 54406, 50267, -50308, 58460, 27421, -62366, 8151, 
    -62225, -25851, -54237, -51634, -31883, -52293, -57204, -24409, -4130, -46364, 54184, 41756, 51988, -818, 35824, -37037, 
    30491, 56586, -26002, 16500, 2588, 52841, -5202, -20106, 21909, -20804, -47433, 40994, -10771, -50843, -37709, -15390, 
    3916, 44155, 8383, -4910, -65475, 21469, 58669, 56327, -15475, -40926, -29694, 54281, 44271, -37554, -20163, -63191, 
    34317, 48803, -44803, -23923, -16306, -50126, 21048, -2943, 16376, -57390, 59260, 15773, 52947, 17168, -8797, 5613, 
    -29817, 18798, -60328, -64121, -49687, 15239, 2450, -35672, 19008, -26489, 43682, -34303, 39671, 29422, -48775, 44559, 
    64603, 1877, -58768, -6962, -18551, -44063, -6228, -53091, 16557, -38726, 4475, -65156, -9671, 66262, -30867, 34086, 
    54436, 813, 3127, 50318, 11894, -61355, 63331, 31047, -5169, -36561, 45059, 41495, -430, 32885, -55923, -21761, 
    -33578, -54238, 52062, -49819, -42248, 45373, 51383, 34615, -27013, 36545, 52960, -25620, -1114, 10895, 56969, -52042, 
    31130, 52607, -19365, -37536, -48583, 57738, -27957, -61532, -22055, -51618, 9251, 46350, -55660, 64932, -53339, -27435, 
    -36209, -37230, -41513, -18577, 1572, -33538, 4453, -54186, 24007, -14077, 50814, 64199, 39340, 12942, 5077, 21926, 
    64104, 57066, -37910, -60387, 48908, -62470, -36582, 64048, 682, 59293, -27707, -65172, 64132, -65813, -32411, -55255, 
    13232, 9686, 50354, -8976, 2852, 54322, 65663, 66316, 38135, 57111, 10894, -46795, -13310, -19200, -56164, 13697, 
    54313, -34670, -16275, -29278, -17630, 17075, -29786, 39646, -44830, 13744, -65849, -58283, -4914, 66223, 33333, 31181, 
    -19398, -21081, 60389, 57908, 29059, 8213, -2960, -36775, -40352, -40806, -32671, 1779, 55851, 33459, -28008, 24408, 
    -2941, -58351, 64242, 12458, 26771, -48996, 4108, 57334, 40891, 38283, 38686, -36109, 33482, -18912, 43188, -5811, 
    40837, -19504, -57497, 49080, -18442, -13701, -56136, 23939, 6112, -46392, 59316, 36257, 49286, -57324, -28906, 209, 
    22298, -21143, -42351, 36223, 23076, -21821, -32187, 26681, -58133, 63665, 45763, -43303, -46454, -47808, 14572, 43424, 
    -64072, 11691, 6160, -9817, -3347, 59382, 51067, -61956, 31282, 13120, 29504, 28358, -65130, 43070, -58994, -51595, 
    34234, 65986, -37332, -58153, -22159, 24444, 45878, 8271, 16670, 50151, 50439, -63462, -19345, -11203, -517, -8447, 
    11120, -2162, 15918, -34747, 57609, -8112, 41500, 61365, 58447, -62912, 25413, -13249, 52558, 17507, -13879, 10384, 
    -62205, 482, 25760, -28951, 46513, -54223, -64791, 43459, -50713, -17746, 38667, -14533, 18084, 34888, -4664, 62583, 
    25550, 27355, 25800, 23715, 43898, 63724, -41120, 39599, 61865, -48780, -54499, 42703, -48035, -46088, 60649, 874, 
    -15671, 20501, 64934, 18357, 48092, -18640, -25683, -9444, -61573, 60503, -2258, 48851, 47776, 17910, -11674, -48345, 
    46326, 39022, -20693, -28850, 38235, 55655, 11516, -66501, 47616, -59633, 13955, 36433, 36179, 64291, -11922, 51113, 
    -42346, 9526, -34424, 16653, -12588, -40362, -56998, -6109, 837, 30412, -40055, -55780, 6096, -14210, -57930, -61762, 
    38205, -50405, -41919, -33965, -5166, -25955, -16158, -15007, 39493, 21364, -55207, -64135, 64811, -17126, 1099, -63925, 
    57612, 2494, -19717, 4863, -25571, 31524, 3356, -27564, -27646, 61736, 57010, 48533, -32921, 5419, -42361, -43504, 
    24601, -44025, 43859, 58967, -55101, -44379, 32673, -39082, -37421, -62182, 62770, 44540, -10118, -49701, 38238, 66261, 
    -58068, -17154, 6231, 63697, -57909, 12480, -43366, -2247, -28478, 4627, -49337, 10143, -19418, -47414, -19608, 35225, 
    48504, 17960, -1821, -48034, 2567, -21401, 23954, -23955, -6611, -31540, -38458, 43439, 18173, 38917, -1448, -16191, 
    52853, 39836, 1268, 45436, -16335, 24844, -8419, 10759, 27704, 54566, 1924, 57184, -59221, -11016, 60295, -52545, 
    -54430, 20399, 7560, -30201, 38249, 60776, -52295, -63935, -22118, -8102, -36402, 34803, 16883, 4451, -36096, 51647, 
    -30597, 56779, 14693, -16911, -45348, -42612, 32101, -20104, -27949, 55498, -16760, 31032, 30717, -31902, 65926, 19888, 
    -8940, -56203, 50890, -22105, -32189, 63984, 63364, 14592, 55725, -12630, 13807, 1314, -20706, 13938, -6320, 65395, 
    19603, -8528, 60695, -58369, -24226, 38565, 25034, -66304, 62080, 1338, 40023, -12977, -4004, -275, 12369, 64850, 
    7153, 39623, -16744, -1150, 29671, 41901, 22146, 18344, -26941, 24847, 48083, -50458, -65003, 3947, 56280, -47335, 
    35226, -65604, 43386, 28580, 59022, 61837, -37571, -59998, -57414, 31897, -26975, -6607, -50283, -50631, -38531, 7228, 
    -9782, -59918, -28895, -5276, -57884, 12116, 23350, 59387, -19882, -45983, 41404, -11785, 22194, 54919, -5724, -1856, 
    -6932, 31707, -11168, -34413, 64503, 3333, -59390, 12744, 64651, 38452, 26728, 20853, -16770, -48695, -51061, -49953
};


/*************************************************
* Name:        ntt
*
* Description: Forward NTT, in-place. No modular reduction is performed after
*              additions or subtractions. Output vector is in bitreversed order.
*
* Arguments:   - uint32_t p[N]: input/output coefficient array
**************************************************/
void ntt(int32_t a[N]) {
    unsigned int len, start, j, k;
    int32_t zeta, t;

    k = 0;
    for (len = (ZETA_N >> 1); len > 0; len >>= 1) {
        for (start = 0; start < N; start = j + len) {
            zeta = zetas[++k];
            // printf("len is %d, zeta is %d\n", len, zeta);
            for (j = start; j < start + len; ++j) {
            t = montgomery_reduce((int64_t)zeta * a[j + len]);
                a[j + len] = a[j] - t; // better mod q
                a[j] = a[j] + t; // better mod q
            }
        }
    }
}

/*************************************************
* Name:        invntt_tomont
*
* Description: Inverse NTT and multiplication by Montgomery factor 2^32.
*              In-place. No modular reductions after additions or
*              subtractions; input coefficients need to be smaller than
*              Q in absolute value. Output coefficient are smaller than Q in
*              absolute value.
*
* Arguments:   - uint32_t p[N]: input/output coefficient array
**************************************************/
void invntt(int32_t a[N]) {
    unsigned int start, len, j, k;
    int32_t zeta, t;

    k = ZETA_N;
    for (len = 1; len < ZETA_N; len <<= 1) {
        for (start = 0; start < N; start = j + len) {
            zeta = zetas[--k];
            for (j = start; j < start + len; ++j) {
                t = a[j];
                a[j] = (t + a[j + len]) % Q; // better mod q
                a[j + len] = a[j + len] - t; // better mod q
                a[j + len] = montgomery_reduce((int64_t)zeta * a[j + len]);
            }
        }
    }

    for (j = 0; j < N; ++j) {
        a[j] = montgomery_reduce((int64_t)a[j] * F);
        // a[j] = montgomery_reduce((int64_t)a[j]);
    }
}
